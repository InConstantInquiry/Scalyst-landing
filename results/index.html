<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalyst &mdash; Diagnostic Results</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://nts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600;700&family=DM+Serif+Display:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-light: #CCFFD6;
            --secondary-light: #AFEFA7
            --mid-accent: #91DE78;
            --primary-accent: #3D9910;
            --primary-accent-light: #56BD1A;
            --dark-anchor: #265420;
            --darker-anchor: #1A3814;
            --white: #FFFFFF;
            --near-black: #0F0F0F;
            --neutral-900: #1A1A1A;
            --neutral-700: #404040;
            --neutral-500: #737373;
            --neutral-200: #E5E5E5;
            --neutral-100: #F5F5F5;
            --font-display: 'IBM Plex Sans', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
            --font-serif: 'DM Serif Display', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-display);
            color: var(--neutral-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            background: var(--white);
        }

        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--neutral-200);
            z-index: 1000;
            padding: 1.25rem 0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-text {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 400;
            color: var(--near-black);
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .nav-back {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            text-decoration: none;
            font-family: var(--font-mono);
            letter-spacing: 0.02em;
        }

        .nav-back:hover { color: var(--primary-accent); }

        main {
            max-width: 640px;
            margin: 0 auto;
            padding: 7rem 2rem 5rem;
        }

        /* Loading state */
        .loading-state { text-align: center; padding: 6rem 0; }
        .loading-state h2 { font-size: 1.5rem; font-weight: 600; color: var(--near-black); margin-bottom: 1.5rem; }
        .loading-bar-track { width: 100%; max-width: 320px; height: 4px; background: var(--neutral-200); border-radius: 2px; margin: 0 auto; overflow: hidden; }
        .loading-bar-fill { height: 100%; width: 0%; background: var(--primary-accent); border-radius: 2px; transition: width 1.5s ease-in-out; }
        .loading-bar-fill.active { width: 100%; }
        .loading-steps { margin-top: 2rem; font-family: var(--font-mono); font-size: 0.8125rem; color: var(--neutral-500); letter-spacing: 0.02em; }
        .loading-step { opacity: 0; transition: opacity 0.3s ease; margin-bottom: 0.25rem; }
        .loading-step.visible { opacity: 1; }

        /* Result state */
        .result-state { display: none; }
        .result-state.visible { display: block; animation: fadeIn 0.6s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-badge {
            display: inline-block;
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--darker-anchor);
            background: var(--white);
            padding: 0.5rem 1rem;
            border: 1.5px solid var(--primary-accent);
            border-radius: 4px;
            margin-bottom: 1.5rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .result-title {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.15;
            color: var(--near-black);
            margin-bottom: 2rem;
            letter-spacing: -0.025em;
        }

        /* Constraint card  NO blur */
        .constraint-card {
            background: var(--neutral-100);
            border: 1.5px solid var(--neutral-200);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .constraint-card-label {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            font-weight: 700;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--primary-accent);
            margin-bottom: 0.75rem;
        }

        .constraint-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--near-black);
        }

        /*  Action Plan Section  */
        .action-plan-section {
            margin-bottom: 2.5rem;
            position: relative;
        }

        .actions-label {
            font-family: var(--font-mono); font-size: 0.6875rem; font-weight: 700;
            letter-spacing: 0.18em; text-transform: uppercase; color: var(--primary-accent); margin-bottom: 1rem;
        }

        .action-card {
            border: 1.5px solid var(--neutral-200);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            background: var(--white);
        }

        .action-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s ease;
        }

        .action-card-header:hover {
            background: var(--neutral-100);
        }

        .action-number {
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--primary-accent);
            flex-shrink: 0;
        }

        .action-summary {
            flex: 1;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--near-black);
            line-height: 1.4;
        }

        .action-chevron {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            color: var(--neutral-500);
        }

        .action-card.expanded .action-chevron {
            transform: rotate(180deg);
        }

        .action-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .action-card.expanded .action-detail {
            max-height: 500px;
        }

        .action-detail-inner {
            padding: 0 1.25rem 1.25rem 3rem;
        }

        .action-step {
            font-size: 0.875rem;
            color: var(--neutral-700);
            line-height: 1.55;
            padding: 0.3rem 0;
            padding-left: 1rem;
            position: relative;
        }

        .action-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.65rem;
            width: 4px;
            height: 4px;
            background: var(--primary-accent);
            border-radius: 50%;
        }

        .action-metric {
            margin-top: 0.75rem;
            padding: 0.625rem 0.875rem;
            background: rgba(61, 153, 16, 0.04);
            border-left: 3px solid var(--primary-accent);
            border-radius: 0 4px 4px 0;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--dark-anchor);
            letter-spacing: 0.01em;
        }

        /* Blur overlay for action details */
        .action-blur-overlay {
            position: relative;
        }

        .action-blur-overlay .action-detail-inner {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
        }

        .action-blur-overlay::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.85) 100%);
            pointer-events: none;
        }

        /* Gate CTA overlay */
        .gate-overlay {
            position: relative;
            margin-top: -1rem;
            margin-bottom: 2.5rem;
            text-align: center;
            padding: 2rem 1.5rem;
            background: var(--neutral-100);
            border: 1.5px solid var(--neutral-200);
            border-radius: 8px;
        }

        .gate-overlay p {
            font-size: 0.9375rem;
            color: var(--neutral-700);
            line-height: 1.55;
            max-width: 460px;
            margin: 0 auto;
        }

        .gate-overlay .gate-cta {
            display: inline-block;
            margin-top: 1.25rem;
            padding: 0.875rem 2rem;
            background: var(--primary-accent);
            color: var(--white);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-family: var(--font-display);
        }

        .gate-overlay .gate-cta:hover {
            background: var(--darker-anchor);
            transform: translateY(-1px);
        }

        /*  Derived Metrics  */
        .metrics-summary { margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid var(--neutral-200); }
        .metrics-label { font-family: var(--font-mono); font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase; color: var(--neutral-500); margin-bottom: 1rem; }
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .metric-item { background: var(--neutral-100); padding: 1rem; border-radius: 6px; }
        .metric-name { font-family: var(--font-mono); font-size: 0.75rem; color: var(--neutral-500); letter-spacing: 0.02em; margin-bottom: 0.25rem; }
        .metric-value { font-family: var(--font-mono); font-size: 1.125rem; font-weight: 700; color: var(--near-black); }

        /*  Why This Matters  */
        .why-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 2px solid var(--neutral-200);
        }
        .why-label {
            font-family: var(--font-mono); font-size: 0.6875rem; font-weight: 700;
            letter-spacing: 0.18em; text-transform: uppercase; color: var(--neutral-500); margin-bottom: 1rem;
        }
        .why-content {
            font-size: 1rem;
            color: var(--neutral-700);
            line-height: 1.65;
        }
        .why-highlight {
            display: inline-block;
            margin-top: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(61, 153, 16, 0.04);
            border: 1.5px solid rgba(61, 153, 16, 0.15);
            border-radius: 8px;
            width: 100%;
        }
        .why-highlight-number {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-accent);
        }
        .why-highlight-label {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--neutral-500);
            letter-spacing: 0.02em;
            margin-top: 0.125rem;
        }

        /*  Feedback Section  */
        .feedback-section { margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid var(--neutral-200); }
        .feedback-label { font-family: var(--font-mono); font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase; color: var(--neutral-500); margin-bottom: 0.5rem; }
        .feedback-heading { font-size: 1.25rem; font-weight: 600; color: var(--near-black); margin-bottom: 1.25rem; }
        .feedback-buttons { display: flex; flex-wrap: wrap; gap: 0.625rem; margin-bottom: 1.5rem; }
        .feedback-btn {
            padding: 0.625rem 1.125rem; border: 1.5px solid var(--neutral-200); border-radius: 6px;
            background: var(--white); font-family: var(--font-display); font-size: 0.875rem;
            font-weight: 500; color: var(--neutral-700); cursor: pointer; transition: all 0.2s ease;
        }
        .feedback-btn:hover { border-color: var(--primary-accent); color: var(--primary-accent); }
        .feedback-btn.selected { border-color: var(--primary-accent); background: rgba(61, 153, 16, 0.06); color: var(--primary-accent); font-weight: 600; }
        .feedback-comment-wrap { display: none; margin-bottom: 1.25rem; }
        .feedback-comment-wrap.visible { display: block; }
        .feedback-comment-label { font-size: 0.875rem; color: var(--neutral-500); margin-bottom: 0.5rem; }
        .feedback-comment-wrap textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1.5px solid var(--neutral-200); border-radius: 6px;
            font-size: 0.9375rem; font-family: var(--font-display); color: var(--neutral-900);
            background: var(--white); resize: vertical; min-height: 80px; transition: border-color 0.2s ease;
        }
        .feedback-comment-wrap textarea:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(61, 153, 16, 0.08); }
        .feedback-comment-wrap textarea::placeholder { color: var(--neutral-500); }
        .feedback-submit {
            display: none; padding: 0.75rem 1.5rem; background: var(--primary-accent); color: var(--white);
            border: none; border-radius: 6px; font-size: 0.9375rem; font-weight: 600;
            cursor: pointer; font-family: var(--font-display); transition: all 0.3s ease;
        }
        .feedback-submit.visible { display: inline-block; }
        .feedback-submit:hover { background: var(--darker-anchor); }
        .feedback-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .feedback-thanks { display: none; padding: 1.25rem; background: var(--neutral-100); border-radius: 6px; font-size: 0.9375rem; color: var(--neutral-700); line-height: 1.5; }
        .feedback-thanks.visible { display: block; }

        /*  Bottom CTAs  */
        .cta-bottom {
            margin-top: 3rem;
            text-align: center;
        }
        .cta-primary {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: var(--primary-accent);
            color: var(--white);
            text-decoration: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-family: var(--font-display);
        }
        .cta-primary:hover { background: var(--darker-anchor); transform: translateY(-1px); }

        .cta-secondary {
            display: block;
            margin-top: 0.875rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--neutral-500);
            text-decoration: none;
            font-family: var(--font-mono);
            letter-spacing: 0.02em;
            transition: color 0.2s ease;
        }
        .cta-secondary:hover { color: var(--primary-accent); }

        /*  No data redirect  */
        .no-data { text-align: center; padding: 6rem 0; display: none; }
        .no-data.visible { display: block; }
        .no-data h2 { font-size: 1.5rem; font-weight: 600; color: var(--near-black); margin-bottom: 1rem; }
        .no-data p { color: var(--neutral-700); margin-bottom: 2rem; }
        .no-data a { display: inline-block; padding: 1rem 2.5rem; background: var(--primary-accent); color: var(--white); text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s ease; }
        .no-data a:hover { background: var(--darker-anchor); }

        @media (max-width: 640px) {
            main { padding: 6rem 1.25rem 3rem; }
            .result-title { font-size: 1.5rem; }
            .metrics-grid { grid-template-columns: 1fr; }
            .feedback-buttons { flex-direction: column; }
            .feedback-btn { text-align: center; }
            .action-detail-inner { padding-left: 1.25rem; }
        }

    .metric-name-clickable {
      cursor: pointer;
      border-bottom: 1px dotted var(--neutral-500);
      display: inline-block;
      transition: color 0.15s ease, border-color 0.15s ease;
    }
    .metric-name-clickable:hover {
      color: var(--primary-accent);
      border-color: var(--primary-accent);
    }
    .metric-popover-overlay {
      position: fixed;
      inset: 0;
      z-index: 999;
    }
    .metric-popover {
      position: absolute;
      z-index: 1000;
      background: var(--white);
      border: 1.5px solid var(--neutral-200);
      border-radius: 8px;
      padding: 1.25rem;
      width: 300px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.1);
      animation: popoverIn 0.15s ease-out;
    }
    @keyframes popoverIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .metric-popover-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    .metric-popover-title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--near-black);
    }
    .metric-popover-close {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--neutral-500);
      padding: 2px;
      line-height: 1;
      font-size: 1.125rem;
    }
    .metric-popover-close:hover {
      color: var(--near-black);
    }
    .metric-popover-section {
      margin-bottom: 0.75rem;
    }
    .metric-popover-section:last-child {
      margin-bottom: 0;
    }
    .metric-popover-label {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--neutral-500);
      margin-bottom: 0.25rem;
    }
    .metric-popover-text {
      font-size: 0.8125rem;
      color: var(--neutral-700);
      line-height: 1.5;
    }
    .metric-popover-interpretation {
      font-size: 0.8125rem;
      color: var(--dark-anchor);
      line-height: 1.5;
      font-weight: 500;
    }
    </style>
    <script defer data-domain="scalyst.digital" src="https://plausible.io/js/script.tagged-events.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo-text">Scalyst</a>
            <a href="/" class="nav-back">&larr; Back to Home</a>
        </div>
    </header>

    <main>
        <!-- No data state -->
        <div class="no-data" id="noData">
            <h2>No diagnostic data found</h2>
            <p>Please complete the diagnostic form first.</p>
            <a href="/diagnostic/">Start Diagnostic</a>
        </div>

        <!-- Loading state -->
        <div class="loading-state" id="loadingState">
            <h2>Analyzing your constraint hierarchy&hellip;</h2>
            <div class="loading-bar-track">
                <div class="loading-bar-fill" id="loadingBar"></div>
            </div>
            <div class="loading-steps">
                <div class="loading-step" id="step1">Evaluating cash position&hellip;</div>
                <div class="loading-step" id="step2">Analyzing margin structure&hellip;</div>
                <div class="loading-step" id="step3">Assessing capacity utilization&hellip;</div>
                <div class="loading-step" id="step4">Mapping conversion efficiency&hellip;</div>
            </div>
        </div>

        <!-- Result state -->
        <div class="result-state" id="resultState">
            <div class="result-badge">Diagnostic Complete</div>
            <h1 class="result-title">Primary Constraint Identified</h1>

            <!-- Constraint card  visible immediately, no blur -->
            <div class="constraint-card">
                <div class="constraint-card-label">Your Primary Growth Constraint</div>
                <div class="constraint-value" id="constraintLabel">&mdash;</div>
            </div>

            <!-- Recommended Action Plan  expandable, details blurred -->
            <div class="action-plan-section" id="actionPlanSection">
                <div class="actions-label">Recommended Action Plan</div>
                <div id="actionCards"></div>
            </div>

            <!-- Gate overlay CTA -->
            <div class="gate-overlay" id="gateOverlay">
                <p>Create your free account to unlock full implementation guidance and track progress.</p>
                <a href="/auth/?mode=signup" class="gate-cta plausible-event-name=ResultsCTA+Click">Create Free Account to Unlock</a>
            </div>

            <!-- Derived metrics -->
            <div class="metrics-summary" id="metricsSummary">
                <div class="metrics-label">Your Derived Metrics</div>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>

            <!-- Why This Matters -->
            <div class="why-section" id="whySection">
                <div class="why-label">Why This Matters</div>
                <div class="why-content" id="whyContent"></div>
            </div>

            <!-- Feedback section -->
            <div class="feedback-section" id="feedbackSection">
                <div class="feedback-label">Feedback</div>
                <div class="feedback-heading">How accurate does this feel?</div>
                <div class="feedback-buttons" id="feedbackButtons">
                    <button class="feedback-btn" data-rating="Extremely accurate">Extremely accurate</button>
                    <button class="feedback-btn" data-rating="Mostly accurate">Mostly accurate</button>
                    <button class="feedback-btn" data-rating="Somewhat accurate">Somewhat accurate</button>
                    <button class="feedback-btn" data-rating="Not accurate">Not accurate</button>
                </div>
                <div class="feedback-comment-wrap" id="feedbackCommentWrap">
                    <div class="feedback-comment-label">What feels off? (Optional)</div>
                    <textarea id="feedbackComment" placeholder="Share any thoughts..."></textarea>
                </div>
                <button class="feedback-submit" id="feedbackSubmitBtn">Submit Feedback</button>
                <div class="feedback-thanks" id="feedbackThanks">Thanks for the feedback &mdash; it helps us improve the diagnostic.</div>
            </div>

            <!-- Bottom CTAs -->
            <div class="cta-bottom">
                <a href="/auth/?mode=signup" class="cta-primary plausible-event-name=ResultsBottomCTA+Click">Create Free Account to Track Progress</a>
                <a href="/diagnostic/" class="cta-secondary">Run Check-In Later</a>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/lib/constraintLogic.js"></script>
    <script>
        // Check for diagnostic data
        var stored = sessionStorage.getItem('scalyst_diagnostic');

        if (!stored) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noData').classList.add('visible');
        } else {
            var data = JSON.parse(stored);
            runLoadingSequence(data);
        }

        function runLoadingSequence(data) {
            requestAnimationFrame(function() {
                document.getElementById('loadingBar').classList.add('active');
            });
            setTimeout(function() { document.getElementById('step1').classList.add('visible'); }, 200);
            setTimeout(function() { document.getElementById('step2').classList.add('visible'); }, 500);
            setTimeout(function() { document.getElementById('step3').classList.add('visible'); }, 900);
            setTimeout(function() { document.getElementById('step4').classList.add('visible'); }, 1200);
            setTimeout(function() {
                document.getElementById('loadingState').style.display = 'none';
                showResults(data);
            }, 1500);
        }

        function showResults(data) {
            // Show constraint immediately  no blur
                        document.getElementById('constraintLabel').textContent = data.constraint.charAt(0).toUpperCase() + data.constraint.slice(1);
            document.getElementById('resultState').classList.add('visible');

            // Build expandable action cards with blurred details
            var details = ACTION_DETAILS[data.constraint] || [];
            var cardsHtml = '';

            details.forEach(function(action, i) {
                cardsHtml += '<div class="action-card" data-index="' + i + '">' +
                    '<div class="action-card-header" onclick="toggleAction(this)">' +
                        '<span class="action-number">0' + (i + 1) + '</span>' +
                        '<span class="action-summary">' + action.summary + '</span>' +
                        '<span class="action-chevron"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>' +
                    '</div>' +
                    '<div class="action-detail">' +
                        '<div class="action-blur-overlay">' +
                            '<div class="action-detail-inner">' +
                                action.steps.map(function(step) {
                                    return '<div class="action-step">' + step + '</div>';
                                }).join('') +
                                '<div class="action-metric">' + action.metric + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            document.getElementById('actionCards').innerHTML = cardsHtml;

            // Show derived metrics
            var d = data.derived;
            var metrics = [
                { name: 'Gross Margin', key: 'grossMargin', raw: (d.grossMargin * 100).toFixed(1), value: (d.grossMargin * 100).toFixed(1) + '%' },
                { name: 'Net Margin', key: 'netMargin', raw: (d.netMargin * 100).toFixed(1), value: (d.netMargin * 100).toFixed(1) + '%' },
                { name: 'Conversion Rate', key: 'conversionRate', raw: (d.conversionRate * 100).toFixed(1), value: (d.conversionRate * 100).toFixed(1) + '%' },
                { name: 'Capacity Utilization', key: 'capacityUtilization', raw: (d.capacityUtilization * 100).toFixed(1), value: (d.capacityUtilization * 100).toFixed(1) + '%' },
                { name: 'Monthly Burn', key: 'monthlyBurn', raw: d.monthlyBurn, value: '$' + d.monthlyBurn.toLocaleString() },
                { name: 'Runway', key: 'runway', raw: d.runwayMonths === Infinity ? 9999 : d.runwayMonths, value: d.runwayMonths === Infinity ? '> 99 mo' : d.runwayMonths.toFixed(1) + ' mo' }
            ];
            var metricsHtml = '';
            metrics.forEach(function(m) {
                metricsHtml += '<div class="metric-item" style="position:relative;">' +
                    '<div class="metric-name"><span class="metric-name-clickable" data-metric="' + m.key + '" data-raw="' + m.raw + '" onclick="showMetricPopover(this)">' + m.name + '</span></div>' +
                    '<div class="metric-value">' + m.value + '</div>' +
                    '</div>';
            });
            document.getElementById('metricsGrid').innerHTML = metricsHtml;

            // Build "Why This Matters" section
            buildWhySection(data);
        }

        function toggleAction(headerEl) {
            var card = headerEl.parentElement;
            card.classList.toggle('expanded');
        }

        function buildWhySection(data) {
            var d = data.derived;
            var raw = data.raw;
            var constraint = data.constraint;

            var monthlyRevenue = Number(raw.monthlyRevenue) || 0;
            var conversionRate = d.conversionRate;
            var grossMargin = d.grossMargin;
            var capacityUtil = d.capacityUtilization;
            var dealsPerMonth = Number(raw.dealsClosedPerMonth) || 0;
            var avgDealValue = Number(raw.averageDealValue) || 0;

            var whyHtml = '';
            var projectedGain = 0;

            if (constraint === 'Conversion') {
                var currentRate = conversionRate;
                var targetRate = Math.min(currentRate + 0.10, 0.35);
                var additionalDeals = Math.round((targetRate - currentRate) * Number(raw.leadsPerMonth));
                projectedGain = additionalDeals * avgDealValue;

                whyHtml = '<p>Your conversion rate is ' + (currentRate * 100).toFixed(1) + '%. ' +
                    'If you improve it to ' + (targetRate * 100).toFixed(0) + '%, that\'s ' +
                    additionalDeals + ' additional deal' + (additionalDeals !== 1 ? 's' : '') +
                    ' per month at $' + avgDealValue.toLocaleString() + ' average value.</p>';

            } else if (constraint === 'Margin') {
                var currentMargin = grossMargin;
                var targetMargin = Math.min(currentMargin + 0.10, 0.55);
                projectedGain = monthlyRevenue * (targetMargin - currentMargin);

                whyHtml = '<p>Your gross margin is ' + (currentMargin * 100).toFixed(1) + '%. ' +
                    'Moving it to ' + (targetMargin * 100).toFixed(0) + '% adds $' +
                    Math.round(projectedGain).toLocaleString() + '/mo in retained profit  without closing a single new deal.</p>';

            } else if (constraint === 'Capacity') {
                var maxCap = Number(raw.maxCapacityPerMonth) || 1;
                var currentOutput = Number(raw.currentOutputPerMonth) || 0;
                var headroom = Math.round(maxCap * 0.20);
                projectedGain = headroom * avgDealValue;

                whyHtml = '<p>You\'re running at ' + (capacityUtil * 100).toFixed(0) + '% capacity. ' +
                    'Freeing up ' + headroom + ' units/mo of throughput means $' +
                    Math.round(projectedGain).toLocaleString() + '/mo in additional revenue capacity.</p>';

            } else if (constraint === 'Cash Flow') {
                var daysToCollect = Number(raw.averageDaysToCollect) || 0;
                var targetDays = 30;
                var daysSaved = Math.max(daysToCollect - targetDays, 0);
                projectedGain = (monthlyRevenue / 30) * daysSaved;

                whyHtml = '<p>You\'re collecting in ' + daysToCollect + ' days. ' +
                    'Cutting to ' + targetDays + ' days frees up $' +
                    Math.round(projectedGain).toLocaleString() + ' in working capital  money you already earned, available sooner.</p>';

            } else {
                // Lead Volume
                var currentLeads = Number(raw.leadsPerMonth) || 0;
                var targetLeads = Math.round(currentLeads * 1.5);
                var additionalDealsLV = Math.round((targetLeads - currentLeads) * conversionRate);
                projectedGain = additionalDealsLV * avgDealValue;

                whyHtml = '<p>You\'re generating ' + currentLeads + ' leads/mo. ' +
                    'Scaling to ' + targetLeads + ' at your current ' + (conversionRate * 100).toFixed(0) + '% close rate adds ' +
                    additionalDealsLV + ' deal' + (additionalDealsLV !== 1 ? 's' : '') +
                    '/mo  $' + Math.round(projectedGain).toLocaleString() + ' in new revenue.</p>';
            }

            if (projectedGain > 0) {
                whyHtml += '<div class="why-highlight">' +
                    '<div class="why-highlight-number">+$' + Math.round(projectedGain).toLocaleString() + '/mo</div>' +
                    '<div class="why-highlight-label">Projected monthly impact from resolving this constraint</div>' +
                    '</div>';
            }

            document.getElementById('whyContent').innerHTML = whyHtml;
        }


        // --- Metric Popover ---
        var METRIC_INFO = {
            grossMargin: {
                title: 'Gross Margin',
                definition: 'Revenue minus the direct cost of delivering your product or service, expressed as a percentage of revenue.',
                whyItMatters: 'This is your engine efficiency. Higher margin means more dollars available to cover overhead, invest, or save for every dollar earned.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val >= 50) return 'Strong margin. You have solid room to reinvest and absorb cost increases.';
                    if (val >= 40) return 'Healthy for most service businesses. You have meaningful room to scale.';
                    if (val >= 25) return 'Stable but limited room for error. Growth may squeeze you without pricing or cost improvements.';
                    return 'Low margin. Revenue growth alone may increase financial stress without structural changes.';
                }
            },
            netMargin: {
                title: 'Net Margin',
                definition: 'What percentage of revenue remains after all expenses — delivery costs, fixed overhead, everything.',
                whyItMatters: 'This is your bottom line. It tells you whether your business is actually generating profit or burning through revenue.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val >= 20) return 'Very strong profitability. You have significant capacity to invest or weather downturns.';
                    if (val >= 10) return 'Solid net margin. Your overhead is well-managed relative to revenue.';
                    if (val >= 0) return 'Thin but positive. Small revenue dips or cost increases could push you negative.';
                    return 'You are currently operating at a loss. Addressing this is foundational to growth.';
                }
            },
            conversionRate: {
                title: 'Conversion Rate',
                definition: 'The percentage of your leads that become paying customers each month.',
                whyItMatters: 'This measures how effectively you turn interest into revenue. Small improvements here compound into significant growth.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val >= 20) return 'Healthy conversion. Your sales process is working well.';
                    if (val >= 10) return 'Room for optimization. Tightening your process could unlock meaningful revenue.';
                    if (val >= 5) return 'Below average. There may be a disconnect between your leads and your offer.';
                    return 'Major revenue leak. This is likely your biggest growth opportunity right now.';
                }
            },
            capacityUtilization: {
                title: 'Capacity Utilization',
                definition: 'How much of your maximum delivery capacity you are currently using.',
                whyItMatters: 'Too low means wasted resources. Too high means no room to take on new business without quality suffering.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val >= 90) return 'Near or at capacity. New growth requires expanding your ability to deliver.';
                    if (val >= 70) return 'Healthy utilization. You have some room to grow without operational changes.';
                    if (val >= 50) return 'Moderate. You have significant unused capacity — the constraint is likely elsewhere.';
                    return 'Low utilization. Your bottleneck is almost certainly demand, not delivery.';
                }
            },
            monthlyBurn: {
                title: 'Monthly Burn',
                definition: 'Your total monthly cash outflow — what it costs to keep the business running each month.',
                whyItMatters: 'This is your baseline survival cost. It determines how long you can operate without new revenue and how urgently you need to grow.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val <= 0) return 'You are cash-flow positive. Your revenue covers all expenses.';
                    if (val <= 10000) return 'Manageable burn. Keep an eye on it as you scale.';
                    if (val <= 50000) return 'Moderate burn. Make sure your runway gives you enough time to hit milestones.';
                    return 'High burn rate. Growth or cost reduction should be a near-term priority.';
                }
            },
            runway: {
                title: 'Runway',
                definition: 'How many months your business can continue operating at the current burn rate with cash on hand.',
                whyItMatters: 'Runway is your decision-making timeline. Less runway means less room for experimentation and more pressure on every bet.',
                interpret: function(v) {
                    var val = parseFloat(v);
                    if (val >= 12 || val >= 9999) return 'Comfortable runway. You have time to be strategic about growth.';
                    if (val >= 6) return 'Adequate cushion, but keep monitoring. Plan for revenue growth or fundraising.';
                    if (val >= 3) return 'Moderate pressure. Important decisions should be made in the next quarter.';
                    return 'High risk. Immediate focus on cash preservation or revenue acceleration is critical.';
                }
            }
        };

        function showMetricPopover(el) {
            closeMetricPopover();
            var key = el.getAttribute('data-metric');
            var rawVal = el.getAttribute('data-raw');
            var info = METRIC_INFO[key];
            if (!info) return;

            var metricItem = el.closest('.metric-item');
            var interpretation = info.interpret(rawVal);

            var overlay = document.createElement('div');
            overlay.className = 'metric-popover-overlay';
            overlay.id = 'metricPopoverOverlay';
            overlay.addEventListener('click', closeMetricPopover);

            var popover = document.createElement('div');
            popover.className = 'metric-popover';
            popover.id = 'metricPopover';
            popover.innerHTML =
                '<div class="metric-popover-header">' +
                    '<div class="metric-popover-title">' + info.title + '</div>' +
                    '<button class="metric-popover-close" onclick="closeMetricPopover()">&times;</button>' +
                '</div>' +
                '<div class="metric-popover-section">' +
                    '<div class="metric-popover-label">Definition</div>' +
                    '<div class="metric-popover-text">' + info.definition + '</div>' +
                '</div>' +
                '<div class="metric-popover-section">' +
                    '<div class="metric-popover-label">Why it matters</div>' +
                    '<div class="metric-popover-text">' + info.whyItMatters + '</div>' +
                '</div>' +
                '<div class="metric-popover-section">' +
                    '<div class="metric-popover-label">Your current value</div>' +
                    '<div class="metric-popover-interpretation">' + interpretation + '</div>' +
                '</div>';

            popover.addEventListener('click', function(e) { e.stopPropagation(); });

            document.body.appendChild(overlay);
            metricItem.style.position = 'relative';
            metricItem.appendChild(popover);

            // Position: try below, flip up if off-screen
            var rect = metricItem.getBoundingClientRect();
            var popRect = popover.getBoundingClientRect();
            if (popRect.bottom > window.innerHeight - 20) {
                popover.style.bottom = '100%';
                popover.style.top = 'auto';
                popover.style.marginBottom = '4px';
            } else {
                popover.style.top = '100%';
                popover.style.marginTop = '4px';
            }
            popover.style.left = '0';

            // On mobile, center the popover
            if (window.innerWidth < 640) {
                popover.style.position = 'fixed';
                popover.style.left = '50%';
                popover.style.top = '50%';
                popover.style.transform = 'translate(-50%, -50%)';
                popover.style.width = 'calc(100vw - 2rem)';
                popover.style.maxWidth = '340px';
                popover.style.margin = '0';
                document.body.appendChild(popover);
            }
        }

        function closeMetricPopover() {
            var overlay = document.getElementById('metricPopoverOverlay');
            var popover = document.getElementById('metricPopover');
            if (overlay) overlay.remove();
            if (popover) popover.remove();
        }

        // --- Feedback handling ---
        var selectedRating = null;

        document.getElementById('feedbackButtons').addEventListener('click', function(e) {
            var btn = e.target.closest('.feedback-btn');
            if (!btn) return;
            var allBtns = document.querySelectorAll('.feedback-btn');
            allBtns.forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            selectedRating = btn.getAttribute('data-rating');
            document.getElementById('feedbackCommentWrap').classList.add('visible');
            document.getElementById('feedbackSubmitBtn').classList.add('visible');
        });

        document.getElementById('feedbackSubmitBtn').addEventListener('click', function() {
            if (!selectedRating) return;
            // No Supabase save for anonymous users  just show thanks
            showFeedbackThanks();
        });

        function showFeedbackThanks() {
            document.getElementById('feedbackButtons').style.display = 'none';
            document.getElementById('feedbackCommentWrap').style.display = 'none';
            document.getElementById('feedbackSubmitBtn').style.display = 'none';
            document.querySelector('.feedback-heading').style.display = 'none';
            document.getElementById('feedbackThanks').classList.add('visible');
        }
    </script>
</body>
</html>
