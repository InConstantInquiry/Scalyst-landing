<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalyst â Launch Analytics Dashboard</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-light: #CCFFD6;
            --secondary-light: #AFEFA7;
            --mid-accent: #91DE78;
            --primary-accent: #3D9910;
            --primary-accent-light: #56BD1A;
            --dark-anchor: #265420;
            --darker-anchor: #1A3814;
            --white: #FFFFFF;
            --near-black: #0F0F0F;
            --neutral-900: #1A1A1A;
            --neutral-700: #404040;
            --neutral-500: #737373;
            --neutral-300: #B3B3B3;
            --neutral-200: #E5E5E5;
            --neutral-100: #F5F5F5;
            --font-display: 'IBM Plex Sans', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-display);
            color: var(--neutral-900);
            line-height: 1.6;
            background: var(--neutral-100);
            -webkit-font-smoothing: antialiased;
        }

        /* ââ Password Gate ââ */
        #auth-gate {
            position: fixed; inset: 0;
            background: var(--darker-anchor);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .auth-box {
            background: var(--white);
            border-radius: 12px;
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .auth-box h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--darker-anchor);
            margin-bottom: 0.5rem;
        }
        .auth-box p {
            color: var(--neutral-500);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .auth-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .auth-box input:focus { border-color: var(--primary-accent); }
        .auth-box button {
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--primary-accent);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .auth-box button:hover { background: var(--dark-anchor); }
        .auth-error {
            color: #D32F2F;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            display: none;
        }

        /* ââ Dashboard Layout ââ */
        #dashboard { display: none; }

        .dash-header {
            background: var(--white);
            border-bottom: 1px solid var(--neutral-200);
            padding: 1.25rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .dash-logo {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--darker-anchor);
        }
        .dash-logo span { color: var(--primary-accent); }
        .dash-meta {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .dash-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            color: var(--neutral-500);
            font-family: var(--font-mono);
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--primary-accent);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .date-range-select {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--neutral-200);
            border-radius: 6px;
            font-family: var(--font-display);
            font-size: 0.85rem;
            background: var(--white);
            cursor: pointer;
            outline: none;
        }
        .date-range-select:focus { border-color: var(--primary-accent); }

        .dash-body {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ââ KPI Cards ââ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--white);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--neutral-200);
        }
        .kpi-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--neutral-500);
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--darker-anchor);
            font-family: var(--font-mono);
            line-height: 1.2;
        }
        .kpi-sub {
            font-size: 0.8rem;
            color: var(--neutral-500);
            margin-top: 0.25rem;
        }

        /* ââ Chart Sections ââ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-card {
            background: var(--white);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--neutral-200);
        }
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: 1rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* ââ Table ââ */
        .table-card {
            background: var(--white);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--neutral-200);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--neutral-200);
            cursor: pointer;
            user-select: none;
        }
        th:hover { color: var(--primary-accent); }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--neutral-100);
            color: var(--neutral-700);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }
        tr:hover td { background: var(--neutral-100); }

        /* ââ Loading / Empty States ââ */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--neutral-300);
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--neutral-200);
            border-top-color: var(--primary-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--neutral-500);
        }
        .empty-state p { font-size: 0.9rem; margin-top: 0.5rem; }

        /* ââ Responsive ââ */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .dash-header { flex-wrap: wrap; gap: 0.75rem; }
            .dash-body { padding: 1rem; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<!-- âââââââââââ PASSWORD GATE âââââââââââ -->
<div id="auth-gate">
    <div class="auth-box">
        <h1>Scalyst Analytics</h1>
        <p>Enter your dashboard password to continue.</p>
        <input type="password" id="password-input" placeholder="Password" autofocus>
        <button id="auth-btn" onclick="authenticate()">Access Dashboard</button>
        <p class="auth-error" id="auth-error">Incorrect password. Try again.</p>
    </div>
</div>

<!-- âââââââââââ DASHBOARD âââââââââââ -->
<div id="dashboard">

    <!-- Header -->
    <div class="dash-header">
        <div class="dash-logo">Scalyst<span>.analytics</span></div>
        <div class="dash-meta">
            <div class="dash-status">
                <div class="status-dot"></div>
                <span id="last-updated">Loading...</span>
            </div>
            <select class="date-range-select" id="date-range" onchange="refreshAll()">
                <option value="day">Today</option>
                <option value="7d" selected>Last 7 days</option>
                <option value="30d">Last 30 days</option>
                <option value="month">This month</option>
                <option value="6mo">Last 6 months</option>
                <option value="all">All time</option>
            </select>
        </div>
    </div>

    <div class="dash-body">

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Unique Visitors</div>
                <div class="kpi-value" id="kpi-visitors">â</div>
                <div class="kpi-sub" id="kpi-visitors-sub"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Pageviews</div>
                <div class="kpi-value" id="kpi-pageviews">â</div>
                <div class="kpi-sub" id="kpi-pageviews-sub"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Bounce Rate</div>
                <div class="kpi-value" id="kpi-bounce">â</div>
                <div class="kpi-sub">% single-page sessions</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Avg Visit Duration</div>
                <div class="kpi-value" id="kpi-duration">â</div>
                <div class="kpi-sub">time on site</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Current Visitors</div>
                <div class="kpi-value" id="kpi-realtime">â</div>
                <div class="kpi-sub">in last 5 minutes</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="chart-grid">
            <!-- Daily Visitors Trend -->
            <div class="chart-card full-width">
                <div class="chart-title">Visitors Over Time</div>
                <div class="chart-container">
                    <canvas id="chart-timeseries"></canvas>
                </div>
            </div>

            <!-- By UTM Source -->
            <div class="chart-card">
                <div class="chart-title">Traffic by Source</div>
                <div class="chart-container">
                    <canvas id="chart-sources"></canvas>
                </div>
            </div>

            <!-- By UTM Medium -->
            <div class="chart-card">
                <div class="chart-title">Traffic by Medium</div>
                <div class="chart-container">
                    <canvas id="chart-medium"></canvas>
                </div>
            </div>

            <!-- Top Pages -->
            <div class="chart-card">
                <div class="chart-title">Top Pages</div>
                <div class="chart-container">
                    <canvas id="chart-pages"></canvas>
                </div>
            </div>

            <!-- By UTM Campaign -->
            <div class="chart-card">
                <div class="chart-title">Campaign Performance</div>
                <div class="chart-container">
                    <canvas id="chart-campaign"></canvas>
                </div>
            </div>
        </div>

        <!-- UTM Content Breakdown Table -->
        <div class="table-card">
            <div class="table-title">Post-Level Performance (UTM Content)</div>
            <table id="content-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Post / Content</th>
                        <th onclick="sortTable(1)">Source</th>
                        <th onclick="sortTable(2)">Visitors</th>
                        <th onclick="sortTable(3)">Pageviews</th>
                        <th onclick="sortTable(4)">Bounce Rate</th>
                        <th onclick="sortTable(5)">Avg Duration</th>
                    </tr>
                </thead>
                <tbody id="content-tbody">
                    <tr><td colspan="6" class="empty-state">Loading data...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Referrer Table -->
        <div class="table-card">
            <div class="table-title">Top Referrers</div>
            <table id="referrer-table">
                <thead>
                    <tr>
                        <th>Referrer</th>
                        <th>Visitors</th>
                        <th>Pageviews</th>
                    </tr>
                </thead>
                <tbody id="referrer-tbody">
                    <tr><td colspan="3" class="empty-state">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// âââââââââââââââââââââââââââââââââââââââââââ
//  CONFIG
// âââââââââââââââââââââââââââââââââââââââââââ
const API_URL = '/api/analytics';
let AUTH_TOKEN = '';
let charts = {};
let refreshInterval;

// Brand colors for charts
const CHART_COLORS = [
    '#3D9910', '#56BD1A', '#91DE78', '#AFEFA7', '#265420',
    '#1A3814', '#6BC74B', '#45A825', '#7AD85E', '#338D0A',
    '#CCFFD6', '#2B6B15', '#4CAF50', '#81C784', '#A5D6A7'
];

// âââââââââââââââââââââââââââââââââââââââââââ
//  AUTHENTICATION
// âââââââââââââââââââââââââââââââââââââââââââ
document.getElementById('password-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') authenticate();
});

async function authenticate() {
    const pw = document.getElementById('password-input').value;
    if (!pw) return;

    // Test the password against the API
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Dashboard-Token': pw,
            },
            body: JSON.stringify({
                metrics: ['visitors'],
                date_range: 'day',
            }),
        });

        if (res.status === 401) {
            document.getElementById('auth-error').style.display = 'block';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
            return;
        }

        // Success â store token and show dashboard
        AUTH_TOKEN = pw;
        sessionStorage.setItem('scalyst_dash_token', pw);
        showDashboard();

    } catch (err) {
        document.getElementById('auth-error').style.display = 'block';
        document.getElementById('auth-error').textContent = 'Connection error. Try again.';
    }
}

function showDashboard() {
    document.getElementById('auth-gate').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    initCharts();
    refreshAll();
    // Auto-refresh every 5 minutes
    refreshInterval = setInterval(refreshAll, 5 * 60 * 1000);
}

// Check session on load
(function checkSession() {
    const saved = sessionStorage.getItem('scalyst_dash_token');
    if (saved) {
        AUTH_TOKEN = saved;
        showDashboard();
    }
})();

// âââââââââââââââââââââââââââââââââââââââââââ
//  API HELPER
// âââââââââââââââââââââââââââââââââââââââââââ
async function query(params) {
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Dashboard-Token': AUTH_TOKEN,
            },
            body: JSON.stringify(params),
        });

        if (res.status === 401) {
            sessionStorage.removeItem('scalyst_dash_token');
            location.reload();
            return null;
        }

        if (!res.ok) {
            console.error('API error:', res.status, await res.text());
            return null;
        }

        return await res.json();
    } catch (err) {
        console.error('Query failed:', err);
        return null;
    }
}

function getDateRange() {
    return document.getElementById('date-range').value;
}

// âââââââââââââââââââââââââââââââââââââââââââ
//  FORMAT HELPERS
// âââââââââââââââââââââââââââââââââââââââââââ
function fmtNumber(n) {
    if (n == null) return 'â';
    return n.toLocaleString();
}

function fmtDuration(seconds) {
    if (seconds == null || seconds === 0) return '0s';
    const m = Math.floor(seconds / 60);
    const s = Math.round(seconds % 60);
    if (m === 0) return s + 's';
    return m + 'm ' + s + 's';
}

function fmtBounce(rate) {
    if (rate == null) return 'â';
    return Math.round(rate) + '%';
}

// âââââââââââââââââââââââââââââââââââââââââââ
//  INIT CHARTS
// âââââââââââââââââââââââââââââââââââââââââââ
function initCharts() {
    Chart.defaults.font.family = "'IBM Plex Sans', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#737373';

    // Timeseries â line chart
    charts.timeseries = new Chart(document.getElementById('chart-timeseries'), {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, grid: { color: '#F5F5F5' } },
            },
            elements: {
                line: { tension: 0.3, borderWidth: 2 },
                point: { radius: 3, hoverRadius: 6 },
            },
        },
    });

    // Sources â horizontal bar
    charts.sources = new Chart(document.getElementById('chart-sources'), {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, grid: { color: '#F5F5F5' } },
                y: { grid: { display: false } },
            },
        },
    });

    // Medium â doughnut
    charts.medium = new Chart(document.getElementById('chart-medium'), {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 16 } },
            },
        },
    });

    // Top Pages â horizontal bar
    charts.pages = new Chart(document.getElementById('chart-pages'), {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, grid: { color: '#F5F5F5' } },
                y: { grid: { display: false } },
            },
        },
    });

    // Campaign â bar
    charts.campaign = new Chart(document.getElementById('chart-campaign'), {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { maxRotation: 45 } },
                y: { beginAtZero: true, grid: { color: '#F5F5F5' } },
            },
        },
    });
}

// âââââââââââââââââââââââââââââââââââââââââââ
//  DATA FETCHING & RENDERING
// âââââââââââââââââââââââââââââââââââââââââââ
async function refreshAll() {
    const range = getDateRange();
    const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    document.getElementById('last-updated').textContent = 'Updated ' + ts;

    // Fire all queries in parallel
    const [overview, timeseries, sources, medium, pages, campaign, content, referrers, realtime] = await Promise.all([
        // KPI overview
        query({ metrics: ['visitors', 'pageviews', 'bounce_rate', 'visit_duration'], date_range: range }),
        // Timeseries
        query({ metrics: ['visitors', 'pageviews'], date_range: range, dimensions: ['time:day'] }),
        // UTM Sources
        query({ metrics: ['visitors', 'pageviews'], date_range: range, dimensions: ['visit:utm_source'], order_by: [['visitors', 'desc']], limit: 15 }),
        // UTM Medium
        query({ metrics: ['visitors'], date_range: range, dimensions: ['visit:utm_medium'], order_by: [['visitors', 'desc']], limit: 10 }),
        // Top Pages
        query({ metrics: ['visitors', 'pageviews'], date_range: range, dimensions: ['event:page'], order_by: [['pageviews', 'desc']], limit: 10 }),
        // UTM Campaign
        query({ metrics: ['visitors'], date_range: range, dimensions: ['visit:utm_campaign'], order_by: [['visitors', 'desc']], limit: 10 }),
        // UTM Content (post-level)
        query({ metrics: ['visitors', 'pageviews', 'bounce_rate', 'visit_duration'], date_range: range, dimensions: ['visit:utm_content', 'visit:utm_source'], order_by: [['visitors', 'desc']], limit: 50 }),
        // Referrers
        query({ metrics: ['visitors', 'pageviews'], date_range: range, dimensions: ['visit:source'], order_by: [['visitors', 'desc']], limit: 15 }),
        // Realtime
        query({ metrics: ['visitors'], date_range: 'realtime' }),
    ]);

    renderKPIs(overview, realtime);
    renderTimeseries(timeseries);
    renderSources(sources);
    renderMedium(medium);
    renderPages(pages);
    renderCampaign(campaign);
    renderContentTable(content);
    renderReferrerTable(referrers);
}

function renderKPIs(data, realtimeData) {
    if (data && data.results && data.results.length > 0) {
        const r = data.results[0];
        const metrics = data.results[0];
        // V2 API returns results as array of metric arrays or objects
        // Handle both formats
        if (Array.isArray(metrics)) {
            document.getElementById('kpi-visitors').textContent = fmtNumber(metrics[0]);
            document.getElementById('kpi-pageviews').textContent = fmtNumber(metrics[1]);
            document.getElementById('kpi-bounce').textContent = fmtBounce(metrics[2]);
            document.getElementById('kpi-duration').textContent = fmtDuration(metrics[3]);
        } else if (metrics.metrics) {
            document.getElementById('kpi-visitors').textContent = fmtNumber(metrics.metrics[0]);
            document.getElementById('kpi-pageviews').textContent = fmtNumber(metrics.metrics[1]);
            document.getElementById('kpi-bounce').textContent = fmtBounce(metrics.metrics[2]);
            document.getElementById('kpi-duration').textContent = fmtDuration(metrics.metrics[3]);
        }
    }

    if (realtimeData && realtimeData.results && realtimeData.results.length > 0) {
        const rt = realtimeData.results[0];
        const val = Array.isArray(rt) ? rt[0] : (rt.metrics ? rt.metrics[0] : 0);
        document.getElementById('kpi-realtime').textContent = fmtNumber(val);
    }
}

function renderTimeseries(data) {
    if (!data || !data.results) return;
    const labels = [];
    const visitors = [];
    const pageviews = [];

    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        labels.push(dims[0] || '');
        visitors.push(mets[0] || 0);
        pageviews.push(mets[1] || 0);
    });

    charts.timeseries.data = {
        labels: labels.map(function(d) {
            if (!d) return '';
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [
            {
                label: 'Visitors',
                data: visitors,
                borderColor: '#3D9910',
                backgroundColor: 'rgba(61, 153, 16, 0.1)',
                fill: true,
            },
            {
                label: 'Pageviews',
                data: pageviews,
                borderColor: '#91DE78',
                backgroundColor: 'rgba(145, 222, 120, 0.1)',
                fill: true,
            },
        ],
    };
    charts.timeseries.options.plugins.legend = { display: true, position: 'top' };
    charts.timeseries.update();
}

function renderSources(data) {
    if (!data || !data.results) return;
    const labels = [];
    const values = [];

    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        const src = dims[0] || '(direct)';
        if (src) { labels.push(src); values.push(mets[0] || 0); }
    });

    charts.sources.data = {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: CHART_COLORS.slice(0, labels.length),
            borderRadius: 4,
        }],
    };
    charts.sources.update();
}

function renderMedium(data) {
    if (!data || !data.results) return;
    const labels = [];
    const values = [];

    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        labels.push(dims[0] || '(none)');
        values.push(mets[0] || 0);
    });

    charts.medium.data = {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: CHART_COLORS.slice(0, labels.length),
            borderWidth: 0,
        }],
    };
    charts.medium.update();
}

function renderPages(data) {
    if (!data || !data.results) return;
    const labels = [];
    const values = [];

    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        labels.push(dims[0] || '/');
        values.push(mets[1] || 0);
    });

    charts.pages.data = {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: '#3D9910',
            borderRadius: 4,
        }],
    };
    charts.pages.update();
}

function renderCampaign(data) {
    if (!data || !data.results) return;
    const labels = [];
    const values = [];

    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        labels.push(dims[0] || '(none)');
        values.push(mets[0] || 0);
    });

    charts.campaign.data = {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: CHART_COLORS.slice(0, labels.length),
            borderRadius: 4,
        }],
    };
    charts.campaign.update();
}

function renderContentTable(data) {
    const tbody = document.getElementById('content-tbody');
    if (!data || !data.results || data.results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><p>No UTM content data yet.</p><p>Data will appear once your launch posts start getting clicks.</p></td></tr>';
        return;
    }

    let html = '';
    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        html += '<tr>';
        html += '<td>' + (dims[0] || '(none)') + '</td>';
        html += '<td>' + (dims[1] || 'â') + '</td>';
        html += '<td>' + fmtNumber(mets[0]) + '</td>';
        html += '<td>' + fmtNumber(mets[1]) + '</td>';
        html += '<td>' + fmtBounce(mets[2]) + '</td>';
        html += '<td>' + fmtDuration(mets[3]) + '</td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
}

function renderReferrerTable(data) {
    const tbody = document.getElementById('referrer-tbody');
    if (!data || !data.results || data.results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No referrer data yet.</td></tr>';
        return;
    }

    let html = '';
    data.results.forEach(function(row) {
        const dims = row.dimensions || [];
        const mets = row.metrics || [];
        html += '<tr>';
        html += '<td>' + (dims[0] || '(direct)') + '</td>';
        html += '<td>' + fmtNumber(mets[0]) + '</td>';
        html += '<td>' + fmtNumber(mets[1]) + '</td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
}

// âââââââââââââââââââââââââââââââââââââââââââ
//  TABLE SORTING
// âââââââââââââââââââââââââââââââââââââââââââ
let sortDir = {};
function sortTable(colIdx) {
    const table = document.getElementById('content-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows.length < 2) return;

    sortDir[colIdx] = !sortDir[colIdx];
    const dir = sortDir[colIdx] ? 1 : -1;

    rows.sort(function(a, b) {
        const aVal = a.cells[colIdx].textContent.replace(/[,%s]/g, '').replace('m ', '.');
        const bVal = b.cells[colIdx].textContent.replace(/[,%s]/g, '').replace('m ', '.');
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) return (aNum - bNum) * dir;
        return aVal.localeCompare(bVal) * dir;
    });

    rows.forEach(function(row) { tbody.appendChild(row); });
}
</script>

</body>
</html>
