<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalyst &mdash; Sign In</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600;700&family=DM+Serif+Display:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-light: #CCFFD6;
            --secondary-light: #AFEFA7;
            --mid-accent: #91DE78;
            --primary-accent: #3D9910;
            --primary-accent-light: #56BD1A;
            --dark-anchor: #265420;
            --darker-anchor: #1A3814;
            --white: #FFFFFF;
            --near-black: #0F0F0F;
            --neutral-900: #1A1A1A;
            --neutral-700: #404040;
            --neutral-500: #737373;
            --neutral-200: #E5E5E5;
            --neutral-100: #F5F5F5;
            --font-display: 'IBM Plex Sans', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
            --font-serif: 'DM Serif Display', serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-display); color: var(--neutral-900); line-height: 1.6; -webkit-font-smoothing: antialiased; background: var(--white); }
        header { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); border-bottom: 1px solid var(--neutral-200); z-index: 1000; padding: 1.25rem 0; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo-text { font-family: var(--font-serif); font-size: 1.75rem; font-weight: 400; color: var(--near-black); letter-spacing: -0.02em; text-decoration: none; }
        .nav-back { font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); text-decoration: none; font-family: var(--font-mono); letter-spacing: 0.02em; }
        .nav-back:hover { color: var(--primary-accent); }
        main { max-width: 440px; margin: 0 auto; padding: 8rem 2rem 5rem; }
        h1 { font-size: 2rem; font-weight: 700; line-height: 1.15; color: var(--near-black); margin-bottom: 0.5rem; letter-spacing: -0.025em; }
        .subtitle { font-size: 1rem; color: var(--neutral-500); margin-bottom: 2rem; }

        .tab-row { display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--neutral-200); }
        .tab-btn { flex: 1; padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; font-family: var(--font-display); font-size: 0.9375rem; font-weight: 600; color: var(--neutral-500); cursor: pointer; transition: all 0.2s ease; }
        .tab-btn.active { color: var(--near-black); border-bottom-color: var(--primary-accent); }
        .tab-btn:hover { color: var(--near-black); }

        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .field { display: flex; flex-direction: column; margin-bottom: 1.25rem; }
        .field label { font-size: 0.875rem; font-weight: 600; color: var(--near-black); margin-bottom: 0.375rem; }
        .field input { padding: 0.875rem 1rem; border: 1.5px solid var(--neutral-200); border-radius: 6px; font-size: 1rem; font-family: var(--font-mono); color: var(--neutral-900); background: var(--white); transition: border-color 0.2s ease; }
        .field input:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(61,153,16,0.08); }

        .submit-btn { display: block; width: 100%; padding: 1rem; background: var(--near-black); color: var(--white); border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: var(--font-display); transition: all 0.3s ease; margin-top: 0.5rem; }
        .submit-btn:hover { background: var(--neutral-700); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .form-error { color: #D32F2F; font-size: 0.8125rem; margin-top: 0.75rem; display: none; }
        .form-error.visible { display: block; }

        .form-success { background: var(--primary-light); border: 1.5px solid var(--primary-accent); border-radius: 8px; padding: 1.25rem; font-size: 0.9375rem; color: var(--darker-anchor); display: none; margin-top: 1rem; }
        .form-success.visible { display: block; }

        .diagnostic-notice { background: var(--neutral-100); border: 1.5px solid var(--neutral-200); border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 2rem; font-size: 0.875rem; color: var(--neutral-700); }
        .diagnostic-notice strong { color: var(--near-black); }
        .diagnostic-notice.hidden { display: none; }

        .password-hint { font-size: 0.75rem; color: var(--neutral-500); margin-top: 0.25rem; font-family: var(--font-mono); }

        @media (max-width: 640px) { main { padding: 6rem 1.25rem 3rem; } h1 { font-size: 1.75rem; } }
    </style>
    <script defer data-domain="scalyst.digital" src="https://plausible.io/js/script.tagged-events.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo-text">Scalyst</a>
            <a href="/" class="nav-back">&larr; Home</a>
        </div>
    </header>
    <main>
        <h1 id="pageTitle">Sign in to Scalyst</h1>
        <p class="subtitle" id="pageSubtitle">Track your constraint over time.</p>

        <div class="diagnostic-notice hidden" id="diagnosticNotice">
            <strong>Your diagnostic is ready.</strong> Create an account to save your results and track changes over time.
        </div>

        <div class="tab-row">
            <button class="tab-btn active" id="tabLogin" onclick="switchTab('login')">Log In</button>
            <button class="tab-btn" id="tabSignup" onclick="switchTab('signup')">Sign Up</button>
        </div>

        <!-- Login Form -->
        <form class="auth-form active" id="loginForm">
            <div class="field">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
            </div>
            <div class="field">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Your password" required>
            </div>
            <button type="submit" class="submit-btn" id="loginBtn">Log In</button>
            <div class="form-error" id="loginError"></div>
        </form>

        <!-- Signup Form -->
        <form class="auth-form" id="signupForm">
            <div class="field">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" placeholder="your@email.com" required>
            </div>
            <div class="field">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="Create a password" required minlength="6">
                <div class="password-hint">Minimum 6 characters</div>
            </div>
            <button type="submit" class="submit-btn" id="signupBtn">Create Account</button>
            <div class="form-error" id="signupError"></div>
            <div class="form-success" id="signupSuccess">
                Check your email for a confirmation link. Once confirmed, you can log in.
            </div>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/lib/constraintLogic.js"></script>
    <script>
        var SUPABASE_URL = 'https://raqwjzcdcfrwwnewwdke.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhcXdqemNkY2Zyd3duZXd3ZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODQ1MzAsImV4cCI6MjA4NjU2MDUzMH0.WEAZ1Kvp4wwQBL1wRJSc0T43C87u79nruU6UqJZpDoE';
        var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        var params = new URLSearchParams(window.location.search);
        var fromDiagnostic = params.get('from') === 'diagnostic';
        var requestedMode = params.get('mode');
        var redirectTo = params.get('redirect') || '/dashboard/';

        // Check if already logged in
        sb.auth.getSession().then(function(res) {
            if (res.data.session) {
                // Already authenticated
                if (fromDiagnostic) {
                    saveDiagnosticAndRedirect(res.data.session.user);
                } else {
                    window.location.href = redirectTo;
                }
            }
        });

        // Show diagnostic notice if coming from results
        if (fromDiagnostic) {
            document.getElementById('diagnosticNotice').classList.remove('hidden');
        }

        // Set initial tab
        if (requestedMode === 'signup' || (fromDiagnostic && requestedMode !== 'login')) {
            switchTab('signup');
        }

        function switchTab(tab) {
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabSignup').classList.toggle('active', tab === 'signup');
            document.getElementById('loginForm').classList.toggle('active', tab === 'login');
            document.getElementById('signupForm').classList.toggle('active', tab === 'signup');
            // Clear errors
            document.getElementById('loginError').classList.remove('visible');
            document.getElementById('signupError').classList.remove('visible');
            document.getElementById('signupSuccess').classList.remove('visible');
        }

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var btn = document.getElementById('loginBtn');
            var errEl = document.getElementById('loginError');
            errEl.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'Logging in...';

            sb.auth.signInWithPassword({ email: email, password: password })
                .then(function(res) {
                    if (res.error) {
                        errEl.textContent = res.error.message;
                        errEl.classList.add('visible');
                        btn.disabled = false;
                        btn.textContent = 'Log In';
                        return;
                    }
                    if (fromDiagnostic) {
                        saveDiagnosticAndRedirect(res.data.user);
                    } else {
                        window.location.href = redirectTo;
                    }
                })
                .catch(function(err) {
                    errEl.textContent = 'Something went wrong. Please try again.';
                    errEl.classList.add('visible');
                    btn.disabled = false;
                    btn.textContent = 'Log In';
                });
        });

        // Signup handler
        document.getElementById('signupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var email = document.getElementById('signupEmail').value.trim();
            var password = document.getElementById('signupPassword').value;
            var btn = document.getElementById('signupBtn');
            var errEl = document.getElementById('signupError');
            var successEl = document.getElementById('signupSuccess');
            errEl.classList.remove('visible');
            successEl.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'Creating account...';

            sb.auth.signUp({
                email: email,
                password: password,
                options: {
                    emailRedirectTo: window.location.origin + '/auth/?from=' + (fromDiagnostic ? 'diagnostic' : 'confirm')
                }
            })
            .then(function(res) {
                if (res.error) {
                    errEl.textContent = res.error.message;
                    errEl.classList.add('visible');
                    btn.disabled = false;
                    btn.textContent = 'Create Account';
                    return;
                }

                // Check if session exists (auto-confirm enabled)
                if (res.data.session) {
                    // User is immediately authenticated
                    saveDiagnosticAndRedirect(res.data.user);
                } else {
                    // Email confirmation required
                    successEl.classList.add('visible');
                    btn.disabled = false;
                    btn.textContent = 'Create Account';
                }
            })
            .catch(function(err) {
                errEl.textContent = 'Something went wrong. Please try again.';
                errEl.classList.add('visible');
                btn.disabled = false;
                btn.textContent = 'Create Account';
            });
        });

        function saveDiagnosticAndRedirect(user) {
            var stored = sessionStorage.getItem('scalyst_diagnostic');
            if (!stored) {
                window.location.href = '/dashboard/';
                return;
            }

            var data = JSON.parse(stored);

            // Create business profile linked to auth user
            sb.from('business_profiles')
                .insert([{ user_id: user.id }])
                .select('id')
                .then(function(res) {
                    if (res.error) {
                        // Profile might already exist (user logging in again)
                        return sb.from('business_profiles')
                            .select('id')
                            .eq('user_id', user.id)
                            .single();
                    }
                    return { data: res.data[0], error: null };
                })
                .then(function(res) {
                    if (res.error || !res.data) {
                        window.location.href = '/dashboard/';
                        return;
                    }

                    var profileId = res.data.id;

                    // Insert constraint snapshot
                    return sb.from('constraint_snapshots')
                        .insert([{
                            business_id: profileId,
                            monthly_revenue: data.raw.monthlyRevenue,
                            cost_of_delivery: data.raw.costOfDelivery,
                            fixed_expenses: data.raw.fixedExpenses,
                            leads_per_month: data.raw.leadsPerMonth,
                            deals_closed_per_month: data.raw.dealsClosedPerMonth,
                            average_deal_value: data.raw.averageDealValue,
                            max_capacity_per_month: data.raw.maxCapacityPerMonth,
                            current_output_per_month: data.raw.currentOutputPerMonth,
                            cash_on_hand: data.raw.cashOnHand,
                            average_days_to_collect: data.raw.averageDaysToCollect,
                            gross_margin: data.derived.grossMargin,
                            net_profit: data.derived.netProfit,
                            net_margin: data.derived.netMargin,
                            conversion_rate: data.derived.conversionRate,
                            capacity_utilization: data.derived.capacityUtilization,
                            monthly_burn: data.derived.monthlyBurn,
                            runway_months: data.derived.runwayMonths === Infinity ? 9999 : data.derived.runwayMonths,
                            primary_constraint: data.constraint
                        }]);
                })
                .then(function() {
                    sessionStorage.removeItem('scalyst_diagnostic');
                    window.location.href = '/dashboard/';
                })
                .catch(function(err) {
                    console.error('Error saving diagnostic:', err);
                    window.location.href = '/dashboard/';
                });
        }
    </script>
</body>
</html>
